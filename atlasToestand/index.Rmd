---
title: "Waterkwaliteit in beeld"
author: "Laura Moria"
date: "`r Sys.Date()`"
always_allow_html: yes
delete_merged_file: TRUE
site: bookdown::bookdown_site
documentclass: book
css: css/factsheet.css
output:
  bookdown::gitbook:
    split_by: none
    download: yes
    link-citations: yes
    config:
      toolbar:
        position: static
biblio-style: apa
editor_options: 
  chunk_output_type: inline
---

```{r global, include = FALSE}
# voor hosten bij bookdown
# replace ../script by ./scripts
# ../hydrobiologie by ./data
#../data by ./data

#  Settings-------------------------------------------------------
rm(list=ls())                               #maakt geheugen leeg voor aanvang
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)

# Load packages and functions-------------------------------------
library(scatterpie); library(ggnewscale); library(tmap); library(cowplot); library(ggspatial) # voor map pie figuur
library(flextable);library(officer) # voor tabel toestand trend
library(knitr)# weergave figuur met inlcude grapics
library(raster) #voor crs functie
library(purrr); library(tidyr); library(broom); library(readxl);library(manipulateWidget);library(rpivotTable);library(kableExtra)
library(dplyr);library(plyr);library(sp);library(plotly);library(sf);library(zoo);
library(leaflet);library(RColorBrewer) #voor kaarten met kleurenlegenda
library(ggplot2);library(data.table)

source("./scripts/fun_map_pie.R")
source('./scripts/createOutput.R')
source('./scripts/ppr_funs.R')
source('./scripts/postProces.R')

# other settings
proj4.rd <- CRS("+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.4171,50.3319,465.5524,-0.398957,0.343988,-1.87740,4.0725 +units=m +no_defs")
proj4.google <- CRS("+proj=longlat +datum=WGS84 +no_defs")
col <- c('3'="blue",'4'="green",'5'="yellow",'6'="orange",'7'="red")
labels <- c('3'="0.8-1",'4'="0.6-0.8",'5'="0.4-0.6",'6'="0.2-0.4",'7'="0-0.2")

outputF <- "word" #"html"
# run for pdf and word
# setwd("D:/stack/Prog KRW/bestuursrapportage/waterkwaliteitsAtlas/atlasToestand")
# bookdown::render_book("index.Rmd", "bookdown::word_document2")
# bookdown::render_book("index.Rmd", "bookdown::pdf_book")
# bookdown::render_book("index.Rmd", "bookdown::html_book")
# bookdown::publish_book(render = 'local')
```

```{r data, include = FALSE}
## data voor kaart ----------
gEAG<- st_read("./data/EAG20191205.gpkg") %>% st_transform(proj4.google)
gEAG$watertype <- NULL
EAG <- st_read("./data/EAG20191205.gpkg") %>% st_transform(28992)
gKRW<- st_read("./data/WBPKRW20200525.gpkg")%>% st_transform(proj4.google)
KRW<- st_read("./data/WBPKRW20200525.gpkg")%>% st_transform(28992)
## aanvullende eag data, krwwatertype niet overal ingevuld en stedelijk landelijk voor EST
## let op: als nieuwe EAG (gEAG) dan deze tabel aanpassen en aanvullen
eag_wl <- fread('./data/EAG_Opp_kenmerken_20201005.csv')

TWNev <- read_excel('./data/TwnList_2019-07-19.xlsx')

hybi <- readRDS('./data/hybi.rds') %>% as.data.table()
EKRset <- readRDS('./data/ekrset.rds') %>% as.data.table()
trendekr <- readRDS('./data/trendekreag.rds') %>% as.data.table()
trendekreag<- readRDS('./data/trendekreag.rds')  %>% as.data.table()
ekrtrend <- readRDS('./data/ekrtrend.rds') %>% as.data.table()
ekrtrendeag <- readRDS('./data/ekrtrendeag.rds')  %>% as.data.table()

EKRlijst <- readRDS('./data/EKRlijstKRW.rds')
#EKRlijst2 <- readRDS('./data/EKRlijstOvWater.rds')
#EKRlijst <- smartbind(EKRlijst,EKRlijst2)

tabset <- readRDS('./data/tabset.rds') %>% as.data.table()
# subsets maken 
ekr_scores1 <- tabset[!grepl("^NL11_*",id) & level == 1, ] # alleen gewogen van KRW waterlichamen en overig water
ekr_scores2 <- tabset[!is.na(tabset$EAGIDENT), ] # alleen gemiddelde scores per EAG selecteren

wq <- readRDS('./data/wq.rds') %>% as.data.table()
pvskp <- readRDS('./data/pvskp.rds') %>% as.data.table()

```

# Inleiding
De informatie over de huidige situatie en ontwikkelingen van het aquatisch ecosysteem in de regio Amstel, Gooi en Vechtstreek is in deze rapportage gebundeld in een atlas met thema kaarten. De ecologische doelstellingen van Amstel, Gooi en Vecht en de huidige ecologische kwaliteit zijn verbeeld in de afbeeldingen hieronder. In hoofdstuk 2 staan kaarten van verschillende indicatoren van ecologische kwaliteit voor de Habitatrichtlijn (Natura2000) en de Kaderrichtlijn water. 

De KRW toestandsbepaling dient watersysteemanalyses, die ten behoeve KRW gebiedsprocessen, operationele besturing en de evaluatie van maatregelen worden uitgevoerd. Daarnaast wordt de ecologische toestand gerapporteerd in de KRW factsheets (www.waterkwaliteitsportaal.nl) en het waterbeheerplan van AGV. 
In het rapport 'Ecologische sleutelfactoren in beeld' wordt verbeeld welke processen deze toestand bepalen. In dit documenten staat de toestand alleen verbeeld. Hier worden de gegevens niet in samenhang geïnterpreteerd of maatregelen geformuleerd.

# Ecologische waterkwaliteit in beeld

Alle beschikbare meetgegevens van hydrobiologische kwaliteitselementen zijn getoetst aan landelijke
beoordelingsmethodiek voor sloten, kanalen (Omschrijving MEP en maatlatten voor sloten en kanalen, STOWA rapport 2012-34) en meren (Referenties en maatlatten voor natuurlijke watertypen voor de Kaderrichtlijn Water, STOWA rapport 2012-31). Het resultaat hiervan is een getal uitgedrukt met behulp van het begrip Ecologische Kwaliteitsratio (EKR score). Deze EKR scores worden de ecologische toestand genoemd. De EKR is de eenheid waarin de feitelijke en de gewenste ecologische toestand van een waterlichaam kan worden uitgedrukt. Een EKR kan worden bepaald voor elk de vier biologische kwaliteitselementen: fytoplankton (algen), waterplanten (overige waterflora), macrofauna (met het blote oog zichtbare ongewervelde dieren, zoals slakken en libellen) en vissen. De EKR heeft daarbij altijd een waarde tussen 0 en 1, waarbij de waarde 1 overeen komt met de natuurlijke referentie. Een score van 1 staat dus voor een maximaal haalbare ecologische kwaliteit in water dat niet door menselijk toedoen wordt verstoord. Een score van 0.6 staat voor een haalbare ecologische kwaliteit in water dat door de mens is gemaakt bij het winnen van turf en zand. Of water dat wordt gebruikt om in te varen of als afvoer om het land en de straat droog te houden.

Bij het bepalen van de doelen rekening worden gehouden met (natuurlijke) fysieke randvoorwaarden, zoals de achtergrondbelasting van nutriënten (wanneer aanwezig). Het gaat hierbij bijvoorbeeld om fosfaatrijke kwel in het westen van het land. Dit betekent dat in gebieden met een bepaalde achtergrondbelasting voor stikstof en/of fosfaat een minder zware norm zou kunnen geldt dan in gebieden zonder die belasting.

De toestand van het water wordt jaarlijks beoordeelt op basis van de van toepassing zijn de kwaliteitselementen. Het oordeel wordt uitgedrukt op basis van een door de KRW voorgeschreven onderverdeling in ecologische toestandsklassen. De ecologische toestand bestaat weer uit verschillende deelbeoordelingen. Deze deelbeoordeling gebeurt op basis van maatlatten. Een maatlat beschrijft de toestand van een waterlichaam per kwaliteitselement in een getal uitgedrukt met behulp van het begrip Ecologische Kwaliteitsratio (EKR score). Voor elk biologisch kwaliteitselement zijn één of meerdere deelmaatlattenonderscheiden op basis van de soortsamenstelling en de (relatieve) aanwezigheid van soorten, en voor vis de leeftijdsopbouw. 

Onderdeel van het beoordelen is het toetsen. Hierbij wordt bepaald hoe een toetswaarde zich verhoudt tot een norm of KRW-doel. Dat resulteert in een oordeel. In onderstaande figuren staan de berkende EKR scores, doelen en de oordelen die daaruit volgen per biologisch kwaliteitselement weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. In KRW waterlichamen wordt een oordeel bepaald voor elk van de 4 biologische kwaliteitselementen en voor de ondersteunende parameters. In het overig water wordt standaard alleen een oordeel bepaald voor het kwaliteitselement waterplanten (overige waterflora). 

## Overzicht oordelen per KRW waterlichaam

```{r mappie, echo=FALSE, fig.cap="Biologische oordelen van de vier biologische kwaliteitselementen in KRW waterlichamen", message=FALSE, warning=FALSE, fig.height = 8, fig.width = 12}

# # Threshold values of EKR for 4 levels, separately defined for 4 EKR type.
# #'Dimension should be 4 rows (= EKR type) x 5 columns (= 5 breaks for 4 levels)
# ekr_breaks = rbind(c(0, 0.2, 0.4, 0.6, 1), #"Fytoplankton
#                     c(0, 0.2, 0.4, 0.6, 1), #Overige waterflora
#                     c(0, 0.2, 0.4, 0.6, 1), #Macrofauna
#                     c(0, 0.2, 0.4, 0.6, 1)) #Vis
# 
# 
# # Make a map with pie chart (based on the numerical variable "EKR") and save as JPEG
# gp_c <- draw_map(KRW, ekr_scores1, bkpl = EAG,
#                  col_ekr = "EKR", ekr_fac = FALSE,
#                  col_area_sf = "OWMIDENT", col_area_dt = "KRW_SGBP3",
#                  ekr_breaks = ekr_breaks,
#                  filename = "map_EKR_waterlichaam.jpg")

# Make a map with pie chart (based on the catagorical variable "oordeel") and save as JPEG
map <- draw_map(pl = KRW, dt =ekr_scores1, bkpl = EAG,
                 col_ekr = "oordeel_2022", ekr_fac = TRUE, 
                 col_area_sf = "OWMIDENT", col_area_dt = "KRW_SGBP3",
                 filename = "map_oordeel_waterlichaam.jpg")

include_graphics('map_oordeel_waterlichaam.jpg')
```

## Overzicht oordelen per Ecologisch analysegebied

```{r kaartenekroordeeldoelmcft1, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

#krw <-
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
              maatlat = "2V1 Overige waterflora", param = "oordeel")

# saveWidget(krw, "waterflora.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")

```

In het overig water wordt standaard alleen een oordeel bepaald voor het kwaliteitselement waterplanten (overige waterflora). 

## Overzicht toestand en trend

Per maatlat en ecologisch analysegebied is berekend hoe de ecologische kwaliteit zich ontwikkeld. Uit deze trends in de toestand van ecologische waterkwaliteit blijkt dat op veel plaatsen de waterkwaliteit achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$estimate < 0 &!is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan, ondanks onze pogingen om het omgaan met water (gebiedsontwikkelingen, agrarisch gebruik, afvalwaterbeheer (opsporen foutaansluitingen)) te beïnvloeden en onze inzet om sloten, zuiveringsinstallaties en waterpeilen te beheren. Een andere invloed op de ecologische toestand in waterlichamen ligt in een toenemende klimaatdruk. Deze uit zich niet alleen in achteruitgang van ecologische kwaliteit en biodiversiteit, maar ook op meer terreinen. Denk bijvoorbeeld aan verhoogde emissies van broeikasgassen uit ondiep, zuurstofloos oppervlaktewater en de gezondheidsrisicos van blauwalgen, botulisme, poepbacterieen en microverontreinigingen.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert door maatregelen die de afgelopen jaren zijn uitgevoerd. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$estimate > 0 &!is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$estimate == 0|is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r toestandtrend, fig.cap = "Toestand, oordeel en trend", echo = FALSE, message = FALSE, warning= FALSE, out.width='100%'}

# hier tekst maken beschrijving trend, deze in ppr ESF oordeel toevoegen (maar dan is ekrtrend wel nodig)-------
# ekrtrend$toelichting <-
#               ifelse(ekrtrend$estimate < 0 & ekrtrend$r.squared < 1, paste0("De score op de maatlat ", ekrtrend$facet_wrap_code, " vertoont een negatieve trend (", ekrtrend$estimate, " ekr per planperiode tussen 2006 en 2019)."),
#               ifelse(ekrtrend$estimate < 0 & ekrtrend$r.squared == 1, paste0("De score op de maatlat ", ekrtrend$facet_wrap_code, " vertoont een negatieve trend (", ekrtrend$estimate, " ekr per planperiode tussen 2006 en 2019). Deze trend is gebaseerd op twee meetjaren."),
#               ifelse(ekrtrend$estimate > 0 & ekrtrend$r.squared < 1, paste0("De score op de maatlat ", ekrtrend$facet_wrap_code, " vertoont een positieve trend (", ekrtrend$estimate, " ekr per planperiode tussen 2006 en 2019)."),
#               ifelse(ekrtrend$estimate < 0 & ekrtrend$r.squared == 1, paste0("De score op de maatlat ", ekrtrend$facet_wrap_code, " vertoont een positieve trend (", ekrtrend$estimate, " ekr per planperiode tussen 2006 en 2019). Deze trend is gebaseerd op twee meetjaren."), paste0("De score op de maatlat ", ekrtrend$facet_wrap_code, " vertoont geen trend.")
#               ))))
# # hier dcast om tabel met header kwaliteitslementen te maken
# ekr_scores_trendbesc <- dcast.data.table(setDT(ekrtrend), id+KRW_SGBP3 ~ facet_wrap_code, value.var = c("toelichting"), drop = T, fill = "")
# # remove NA
# ekr_scores_trendbesc[is.na(ekr_scores_trendbesc)] <- ""
# # merge tekst
# ekr_scores_trendbesc$mergetekst <- paste0(ekr_scores_trendbesc$Fytoplankton, " ", ekr_scores_trendbesc$Waterflora," ",ekr_scores_trendbesc$Macrofauna," ", ekr_scores_trendbesc$Vis )
# # trim character columns from starting and ending space
# cols <- colnames(ekr_scores_trendbesc)[sapply(ekr_scores_trendbesc, is.character)] # which colnames are character
# ekr_scores_trendbesc[,(cols) := lapply(.SD, function(x) gsub("^\\s+|\\s+$", "", x)),.SDcols = cols]
# write.table(ekr_scores_trendbesc, file = paste(getwd(),"/output/trendbesch",format(Sys.time(),"%Y%m%d%H%M"),".csv", sep= ""), quote = FALSE, na = "", sep =';', row.names = FALSE)


# hier dcast om tabel met header kwaliteitslementen te maken ------
ekr_scores_sel2 <- dcast.data.table(setDT(ekrtrend), waterlichaam+KRW_SGBP3 ~ facet_wrap_code, value.var = c("EKR3jr","oordeelsort","estimate","GEP_2022"), fun.aggregate = mean)

typology <- data.frame(
  col_keys = c( "waterlichaam", 
                          "EKR3jr_Fytoplankton","GEP_2022_Fytoplankton","estimate_Fytoplankton",
                          "EKR3jr_Macrofauna","GEP_2022_Macrofauna","estimate_Macrofauna",
                          "EKR3jr_Waterflora","GEP_2022_Waterflora","estimate_Waterflora",
                          "EKR3jr_Vis", "GEP_2022_Vis","estimate_Vis"),
  what = c("Waterlichaam",
           "Fytoplankton", "Fytoplankton", "Fytoplankton",
           "Macrofauna","Macrofauna","Macrofauna",
           "Waterflora","Waterflora","Waterflora",
           "Vis","Vis","Vis"),
  measure = c("Waterlichaam",
              "EKR3jr", "GEP", "trend",
              "EKR3jr", "GEP", "trend",
              "EKR3jr", "GEP", "trend",
              "EKR3jr", "GEP", "trend"),
  stringsAsFactors = FALSE )

#ft<- 
  ekr_scores_sel2 %>%
    flextable(col_keys = c("waterlichaam",
                           "EKR3jr_Fytoplankton","GEP_2022_Fytoplankton","estimate_Fytoplankton",
                           "EKR3jr_Macrofauna","GEP_2022_Macrofauna","estimate_Macrofauna",
                           "EKR3jr_Waterflora","GEP_2022_Waterflora","estimate_Waterflora",
                           "EKR3jr_Vis", "GEP_2022_Vis","estimate_Vis")) %>%
    set_header_df(mapping = typology, key = "col_keys" )%>%
    merge_h(part = "header")%>%
    merge_v(part = "header")%>%
    theme_booktabs()%>%
    border_inner(border= fp_border(width = 3, color = "white"), part="all")%>%
    colformat_num(j = 2:13, digits=2)%>%
    width(j = 1, width = 5)%>%
    width(j = 2:13, width = 1)%>%
    bg(~ oordeelsort_Fytoplankton > 1, bg = "green", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Fytoplankton < 1, bg = "yellow", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Fytoplankton < 0.67, bg = "orange", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Fytoplankton < 0.34, bg = "red", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Macrofauna > 1, bg = "green", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Macrofauna < 1, bg = "yellow", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Macrofauna < 0.67, bg = "orange", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Macrofauna < 0.34, bg = "red", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Waterflora > 1, bg = "green", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Waterflora < 1, bg = "yellow", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Waterflora < 0.67, bg = "orange", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Waterflora < 0.34, bg = "red", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Vis > 1, bg = "green", ~ EKR3jr_Vis)%>%
    bg(~ oordeelsort_Vis < 1, bg = "yellow", ~ EKR3jr_Vis)%>%
    bg(~ oordeelsort_Vis < 0.67, bg = "orange", ~ EKR3jr_Vis)%>%
    bg(~ oordeelsort_Vis < 0.34, bg = "red", ~ EKR3jr_Vis)%>%
    bg(~ estimate_Fytoplankton > 0, bg = "lightgreen", ~ estimate_Fytoplankton)%>%
    bg(~ estimate_Fytoplankton == 0, bg = "lightyellow", ~ estimate_Fytoplankton)%>%
    bg(~ estimate_Fytoplankton < 0, bg = "salmon", ~ estimate_Fytoplankton)%>%
    bg(~ estimate_Waterflora > 0, bg = "lightgreen", ~ estimate_Waterflora)%>%
    bg(~ estimate_Waterflora == 0, bg = "lightyellow", ~ estimate_Waterflora)%>%
    bg(~ estimate_Waterflora < 0, bg = "salmon", ~ estimate_Waterflora)%>%
    bg(~ estimate_Macrofauna > 0, bg = "lightgreen", ~ estimate_Macrofauna)%>%
    bg(~ estimate_Macrofauna == 0, bg = "lightyellow", ~ estimate_Macrofauna)%>%
    bg(~ estimate_Macrofauna < 0, bg = "salmon", ~ estimate_Macrofauna)%>%
    bg(~ estimate_Vis > 0, bg = "lightgreen", ~ estimate_Vis)%>%
    bg(~ estimate_Vis == 0, bg = "lightyellow", ~ estimate_Vis)%>%
    bg(~ estimate_Vis < 0, bg = "salmon", ~ estimate_Vis)

# save_as_docx(ft, path = "ekrtrendkrwovwat.docx")
    
```

## Trend per maatlat

```{r trenddkaart, fig.cap = "Trend", echo = FALSE, message = FALSE, warning= FALSE, out.width='100%'}
krw<- 
combineWidgets(
    nrow = 2,
    plottrendEAG(ekrtrendeag[ekrtrendeag$facet_wrap_code == 'Waterflora',], gEAG),
    plottrendEAG(ekrtrendeag[ekrtrendeag$facet_wrap_code == 'Macrofauna',], gEAG),
    plottrendEAG(ekrtrendeag[ekrtrendeag$facet_wrap_code == 'Fytoplankton',], gEAG),
    plottrendKRW(ekrtrend[ekrtrend$facet_wrap_code == 'Vis',], gKRW)
)
# saveWidget(krw, "trendallemaatlatten.html", selfcontained = FALSE)
```

## Toestand per biologisch kwaliteitselement

Als graadmeter voor de (ecologische) toestand in het gehele beheergebied is de hoeveelheid en soortensamenstelling van de aanwezige vegetatie (waterplanten) gebruikt. Dit vormt namelijk een goede maatstaf voor de ecologische toestand van een oppervlaktewater: waterplanten zijn een essentieel onderdeel van, en randvoorwaarde voor watergebonden leven als kleine waterdiertjes en vissen. De aanwezigheid van waterplanten is getoetst volgens de landelijke maatlatten voor sloten, kanalen en meren. In gebieden die zijn aangewezen als KRW waterlichaam wordt sinds 2006 ook de toestand van de andere drie biologische kwaliteitselementen (fytoplankton, macrofauna, en vissen) ook gevolgd.

### Overige waterflora

Het beheergebied van AGV is zeer divers en daarom opgedeeld in kleinere [Ecologische analysegebieden](EAG), elk met een eigen bodemtype en waterhuishouding. In elk gebied is de hoeveelheid en soortensamenstelling van waterplanten op meerdere plaatsen gemeten en getoetst. De vegetatie wordt gemiddeld eens in de 3 jaar gemeten in ieder EAG. In onderstaande afbeeldingen worden de berekende oordelen, doelen en EKR scores per Ecologisch analysegebied op vegetatiemaatlat weergegeven. Als je op een deelgebied klikt, dan verschijnt er een pop-up waar je kan zien wat de EKR score is. 

In afbeelding \@ref(fig:kaartenekroordeeldoelmcft) staan de berkende EKR scores, doelen en de oordelen die daaruit volgen weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. De actuele toestand van vegetatie is gebaseerd op metingen in meerdere jaren. De gemeten vegetatie laat van nature fluctuaties zien in de tijd en een gemiddelde van verschillende jaren geeft een betrouwbaarder beeld van de ecologische toestand. In de systematiek van de KRW wordt een oordeel gegeven door dit ‘slepend gemiddelde’ van EKR scores per gebied te vergelijken met een doel.

```{r kaartenekroordeeldoelmcft, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw <-
combineWidgets(
    ncol = 3,
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
              maatlat = "2V1 Overige waterflora", param = "oordeel"),
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
              maatlat = "2V1 Overige waterflora", param = "ekr3jr"),
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
              maatlat = "2V1 Overige waterflora", param = "doel")
)

#saveWidget(krw, "waterfloradeelmtlt.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")

```

In veel waterlichamen worden doelen nog niet gehaald. Niet in alle gebieden is het onze ambitie om hoger te scoren dan een EKR van 0.6 (groen). Er is voor ieder water gekeken naar een haal- en betaalbaar handelingsperspectief. Op basis daarvan worden uiteindelijke doelen of ambities geformuleerd. In onderstaande kaart staat weergegeven hoe groot de opgave is om de doelen te bereiken.

Voor overig water worden op dit moment haalbare maatregelenpakketten bedacht om het handelingsperspectief en doelen te bepalen. Een eerste aanzet voor doelen overig water is nu gemaakt op basis van het 90 percentiel van gemeten EKR scores in een gebied. Deze 10% beste meetlocaties geven namelijk een eerste beeld van een realistisch ecologische toestand die voor kan komen in een EAG.

```{r doelgatmap, fig.cap = 'Overzicht van het doelgat (de afstand van de huidige toestand tot het doel) voor de maatlat Overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

KRWmapEAG(gEAG, ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
              maatlat = "2V1 Overige waterflora", param = 'doelgat')
                  
#doelmapEAG(tabset[tabset$wbmethode == "Maatlatten2018 Ov. waterflora" & !tabset$KRW_SGBP3 == "",], maatlat = "2V1 Overige waterflora") #alleenovwater
```

#### Trend Overige waterflora

In afbeelding \@ref(fig:kaartvegjaren) is te zien hoe de vegetatie scoort (EKR score op de maatlat 'Overige waterflora') in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 jaar vegetatie gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartvegjaren, fig.cap = 'Overzicht van EKR scores per EAG per jaar op de maatlat Overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw <-
combineWidgets(
    ncol = 4, colsize = c(1,1),
    ekrmap2(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2009'& EKRset$Waardebepalingsmethode.code %in% c("Maatlatten2018 Ov. waterflora"),], maatlat = "2V1 Overige waterflora",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2009' & EKRset$jaar < '2012'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Ov. waterflora",], maatlat = "2V1 Overige waterflora",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2012' & EKRset$jaar < '2015'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Ov. waterflora",], maatlat = "2V1 Overige waterflora",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2015' & EKRset$jaar < '2020'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Ov. waterflora",], maatlat = "2V1 Overige waterflora",col=col,labels=labels))

# saveWidget(krw, "waterflorapermpjaar.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen de vegetatie (overige waterflora) achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora' & ekrtrendeag$estimate < 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora' & ekrtrendeag$estimate > 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora' & (ekrtrendeag$estimate == 0| is.na(ekrtrendeag$estimate))])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendveg1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat overige waterflora per ecologisch analysegebied tussen 2006 en 2019', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

#krw<-
combineWidgets(
    ncol = 3,
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '2V21 Soortensamenstelling macrofyten',], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR == 'Soortensamenstelling macrofyten Oeverplanten',], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR == 'Soortensamenstelling macrofyten Waterplanten',], gEAG)
    )

combineWidgets(
    ncol = 3,
    plottrendEAG(trendekreag[trendekreag$GHPR_level %in% c('2V3 Bedekking som submerse planten en draadalgen', 
                                                           '2V3 Vestigingsdiepte waterplanten'),], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '2V3 Bedekking Emerse planten',], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '2V3 Bedekking Flab (Floating Algae Beds)',], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '2V3 Bedekking Kroos',], gEAG)
)
# saveWidget(krw, "trenddeelmtltwaterflora.html", selfcontained = FALSE)
# webshot("trendbiodivwaterflora.html", file = "trendbiodivwaterflora.png")
```

### Fytoplankton

In gebieden die zijn aangewezen als KRW waterlichaam wordt sinds 2006 de toestand van fytoplankton, macrofauna, en vissen gevolgd. Deze zogenaamde kwaliteitselementen worden eens in de 3 of 6 jaar gemeten. In onderstaande afbeeldingen worden de berekende EKR scores per [KRW waterlichamen] en kwaliteitselement weergegeven.

```{r kaartKRWfyto, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat op de maatlat Fytoplankton.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw <- 
combineWidgets(
    ncol = 3,
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
              maatlat = "1F1 Fytoplankton-kwaliteit", param = "oordeel"),
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
              maatlat = "1F1 Fytoplankton-kwaliteit", param = "ekr3jr"),
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
              maatlat = "1F1 Fytoplankton-kwaliteit", param = "doel")
)

# saveWidget(krw, "fytoplankton.html", selfcontained = FALSE)
#webshot("fytoplankton.html", file = "fytoplankton.png")
```

In veel waterlichamen worden doelen nog niet gehaald. Niet in alle gebieden is het onze ambitie om hoger te scoren dan een EKR van 0.6 (groen). Er is voor ieder water gekeken naar een haal- en betaalbaar handelingsperspectief. Op basis daarvan worden uiteindelijke doelen of ambities geformuleerd. In onderstaande kaart staat weergegeven hoe groot de opgave is om de doelen te bereiken.

```{r doelgatmapfyto, fig.cap = 'Overzicht van het doelgat (de afstand van de huidige toestand tot het doel) voor de maatlat Fytoplankton.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

KRWmapEAG(gEAG, ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
              maatlat = "1F1 Fytoplankton-kwaliteit", param = 'doelgat')
```

Fytoplankton reageert vaak sneller op ontwikkelingen dan vegetatie. Vooral in grotere wateren is dit ook een goede indicator voor schoon water en zwemwaterkwaliteit. Fytoplankton laat globaal eenzelfde beeld zien als vegetatie, al is er op deze maatlat minder sprake van achteruitgang. Naast de scores op de hoofdmaatlat 'Fytoplankton-kwaliteit' kan ook worden gekeken naar scores op de indicator 'abundantie fytoplankton', die is berekend op basis van het zomerhalfjaar gemiddelde Chlorofyl-A gehalte.

```{r kaartchlorofyl, fig.cap = 'Overzicht van gemiddeld chlorofyl-A gehalte in 2006 t/m 2012 links en 2013 t/m 2017 rechts.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
wq1 <- wq[grep('VAST', wq$locatie.meetnethistorie),]
#wq2 <- wq1[wq1$] # voor een boezemkaartje
#chlfa<-
combineWidgets(
    ncol = 2, colsize = c(1, 1),
    chlorofylA(wq1[wq1$jaar < '2013'& wq1$jaar > '2005',]),
    chlorofylA(wq1[wq1$jaar > '2012'& wq1$jaar < '2018',])
)
#saveWidget(chlfa, "chlfa.html", selfcontained = FALSE)
#webshot("chlfa.html", file = "chlfa.png")
```

#### Trend Fytoplankton

In afbeelding \@ref(fig:kaartfytojaren) is te zien hoe fytoplankton scoort in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 of 6 jaar de samenstelling van fytoplankton gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartfytojaren, fig.cap = 'Overzicht van EKR scores per EAG per jaar op de maatlat Fytoplankton.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw <-
combineWidgets(
    ncol = 4, 
    ekrmap2(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2009'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Fytoplankton",], maatlat = "1F1 Fytoplankton-kwaliteit",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2009' & EKRset$jaar < '2012'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Fytoplankton",], maatlat = "1F1 Fytoplankton-kwaliteit",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2012' & EKRset$jaar < '2015'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Fytoplankton",], maatlat = "1F1 Fytoplankton-kwaliteit",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2015' & EKRset$jaar < '2020'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Fytoplankton",], maatlat = "1F1 Fytoplankton-kwaliteit",col=col,labels=labels))

# saveWidget(krw, "fytopermpjaar.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen de vegetatie (overige waterflora) achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit' & ekrtrendeag$estimate < 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit' & ekrtrendeag$estimate > 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit' & (ekrtrendeag$estimate == 0| is.na(ekrtrendeag$estimate))])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendfyt1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat overige waterflora per ecologisch analysegebied tussen 2006 en 2019', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

#krw<-
combineWidgets(
    ncol = 3,
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '1F1 Fytoplankton-kwaliteit',], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '1F2 Abundantie fytoplankton',], gEAG),
    plottrendEAG(trendekreag[trendekreag$GHPR_level == '1F2 Soortensamenstelling fytoplankton',], gEAG)
)
# saveWidget(krw, "trenddeelmtltfyto.html", selfcontained = FALSE)
# webshot("trendbiodivwaterflora.html", file = "trendbiodivwaterflora.png")
```

### Macrofauna

Macrofauna zijn kleine, maar met het blote oog zichtbare, ongewervelde dieren (insecten, slakken, etc) die in het oppervlaktewater leven. Van elk meetpunt van is de aanwezige macrofauna vergeleken met een voor ieder watertype maximaal haalbare kwaliteit. Aquatische macrofauna heeft vegetatie nodig als schuilplaats, voedsel of voor hun voortplanting. Daarom is een gezonde macrofaunagemeenschap afhankelijk van de hoeveelheid en kwaliteit van emerse en submerse vegetatie.

In afbeelding \@ref(fig:kaartenekroordeeldoelmafa) staan de berkende EKR scores, doelen en de oordelen die daaruit volgen weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. De actuele toestand van macrofauna is gebaseerd op metingen in meerdere jaren. De gemeten vegetatie laat van nature fluctuaties zien in de tijd en een gemiddelde van verschillende jaren geeft een betrouwbaarder beeld van de ecologische toestand. In de systematiek van de KRW wordt een oordeel gegeven door dit ‘slepend gemiddelde’ van EKR scores per gebied te vergelijken met een doel.

```{r kaartenekroordeeldoelmafa, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw<- 
combineWidgets(
    ncol = 3,
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
              maatlat = "3M1 Macrofauna-kwaliteit", param = "oordeel"),
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
              maatlat = "3M1 Macrofauna-kwaliteit", param = "ekr3jr"),
    KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
              maatlat = "3M1 Macrofauna-kwaliteit", param = "doel")
)

# saveWidget(krw, "macrofauna.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")

```

In veel waterlichamen worden doelen nog niet gehaald. Niet in alle gebieden is het onze ambitie om hoger te scoren dan een EKR van 0.6 (groen). Er is voor ieder water gekeken naar een haal- en betaalbaar handelingsperspectief. Op basis daarvan worden uiteindelijke doelen of ambities geformuleerd. In onderstaande kaart staat weergegeven hoe groot de opgave is om de doelen te bereiken.

```{r doelgatmapmafa, fig.cap = 'Overzicht van het doelgat (de afstand van de huidige toestand tot het doel) voor de maatlat Macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

KRWmapEAG(gEAG, ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
              maatlat = "3M1 Macrofauna-kwaliteit", param = 'doelgat')
```

De natuurkwaliteit van macrofauna is laag voor alle typen oppervlaktewater. Slechts op enkele plaatsen wordt een goede kwaliteit aangetroffen. In het achterland van Loosdrecht, de Tiehovense plassen, de Hollands Ankeveense plassen, de Westbroekse zodden, Molenpolder Natuur en het Hol valt op dat de score op de macrofauna maatlat voldoet, terwijl scores op de maatlat 'Overige waterflora' onvoldoende zijn. Macrofauna wordt minder frequent bemonsterd en daarom zijn deze resultaten meestal op oudere meetdata gebaseerd. Ook in eerdere meetjaren valt op dat macrofauna in bovengenoemde gebieden voldoet, terwijl de scores op de maatlat 'Overige waterflora' (vegetatie) niet voldoen. In het achterland van Loosdrecht gaat zowel de kwaliteit van macrofauna als waterflora achteruit.

```{r figmafa, fig.cap = 'Aantal individuen van gevoelige macrofauna uit de EPT groep (haften, steenvliegen, kokerjuffers) per monster', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
if(nrow(hybi[hybi$analysecode == 'MEA',])>0){
plotmafa2(hybi[!is.na(hybi$TWN.taxongroup),],TWNev)}
```

#### Trend Macrofauna

In afbeelding \@ref(fig:kaartmafajaren) is te zien hoe macrofauna scoort in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 jaar vegetatie gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartmafajaren, fig.cap = 'Overzicht van EKR scores per EAG per jaar op de maatlat Macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw <-
combineWidgets(
    ncol = 4, 
    ekrmap2(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2009'& EKRset$Waardebepalingsmethode.code %in% c("Maatlatten2018 Macrofauna"),], maatlat = "3M1 Macrofauna-kwaliteit",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2009' & EKRset$jaar < '2012'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Macrofauna",], maatlat = "3M1 Macrofauna-kwaliteit",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2012' & EKRset$jaar < '2015'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Macrofauna",], maatlat = "3M1 Macrofauna-kwaliteit",col=col,labels=labels),
    ekrmap2(EKRset[EKRset$jaar >= '2015' & EKRset$jaar < '2020'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Macrofauna",], maatlat = "3M1 Macrofauna-kwaliteit",col=col,labels=labels))

#saveWidget(krw, "macrofaunapermpjaar.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen de vegetatie (overige waterflora) achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit' & ekrtrendeag$estimate < 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit' & ekrtrendeag$estimate > 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit' & (ekrtrendeag$estimate == 0| is.na(ekrtrendeag$estimate))])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendmafa1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat macrofauna per ecologisch analysegebied tussen 2006 en 2019', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
plottrendEAG(trendekreag[trendekreag$GHPR_level == '3M1 Macrofauna-kwaliteit',], gEAG)
# saveWidget(krw, "trendbiodivwaterflora.html", selfcontained = FALSE)
# webshot("trendbiodivwaterflora.html", file = "trendbiodivwaterflora.png")
```

### Vis

In afbeelding \@ref(fig:kaartenekroordeeldoelvis) staan de berkende EKR scores, doelen en de oordelen die daaruit volgen weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. De actuele toestand van vis is gebaseerd op metingen in meerdere jaren. Visbemonsteringen laat van nature fluctuaties zien in de tijd en een gemiddelde van verschillende jaren geeft een betrouwbaarder beeld van de ecologische toestand. In de systematiek van de KRW wordt een oordeel gegeven door dit ‘slepend gemiddelde’ van EKR scores per gebied te vergelijken met een doel.

```{r kaartenekroordeeldoelvis, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
# vis is niet beschikbaar per eag --> daarom projectie KRW wl op alle eags van dat waterlichaam
ekr_scores_vis <- merge(tabset[tabset$wbmethode == "Maatlatten2018 Vis" ,], eag_wl[!eag_wl$KRW_SGBP3 == "", c('GAFIDENT','KRW_SGBP3')], by = 'KRW_SGBP3', all.y = T, allow.cartesian = T)
ekr_scores_vis$EAGIDENT <- ekr_scores_vis$GAFIDENT

krw <- combineWidgets(
    ncol = 3,
    KRWmapEAG(gEAG,ekr_scores_vis, 
              maatlat = "4VI1 Vis-kwaliteit" , param = "oordeel"),
    KRWmapEAG(gEAG,ekr_scores_vis, 
              maatlat = "4VI1 Vis-kwaliteit" , param = "ekr3jr"),
    KRWmapEAG(gEAG,ekr_scores_vis, 
              maatlat = "4VI1 Vis-kwaliteit" , param = "doel")
)
krw
# saveWidget(krw, "vistoestand.html", selfcontained = FALSE)

```

```{r vispivot, fig.cap = 'Visbiomassa per soort', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

selKol <- c("Numeriekewaarde","Biotaxon.naam.nl","HoortBijGeoobject.identificatie","Begindatum","Resultaatdatum","HoortBijGeoObjectCode","Eenheid.code")
sel <- !grepl('^NL11*', EKRlijst$HoortBijGeoobject.identificatie)
sel <- sel & !is.na(EKRlijst$Biotaxon.naam.nl) & !EKRlijst$Biotaxon.naam.nl == "" &!(EKRlijst$Biotaxon.naam.nl %in% "Vissen")  #als geen nederlandse naam dan gaat aggregate fout. En ook niet relevant.
sel <- sel & EKRlijst$Eenheid.code %in% "kg/ha"
EKRlijst1 <- EKRlijst[sel,]
EKRlijst1 <- EKRlijst1[,ltstmj := jaar==max(jaar,na.rm=T), by = c('HoortBijGeoobject.identificatie','EAGIDENT')]
EKRlijst1 <- EKRlijst1[ltstmj == TRUE,]

xagg <- aggregate(Numeriekewaarde ~ Biotaxon.naam.nl+jaar+HoortBijGeoobject.identificatie,EKRlijst1,FUN=sum)
xagg$jaar <- as.character(xagg$jaar)
colgroup <-c('Biotaxon.naam.nl','jaar','HoortBijGeoobject.identificatie','Numeriekewaarde')

# rename columns and order data.table
setnames(xagg,colgroup,c('vissoort','jaar','waterlichaam','biomassa'))
xagg <- as.data.frame(xagg)

# calculate mean per groep
krw <- rpivotTable(
    xagg,
    rows=c("waterlichaam","jaar"),
    cols= "vissoort",
    aggregatorName = "Sum",
    # sorter = '',
    # inclusions = list(HoortBijGeoobject.identificatie = list("NL11_Botshol")),
    exclusions= list(jaar = list('2006','2007','2008','2009','2010','2011','2012')),
    vals = "biomassa",
    rendererName = "Horizontal Stacked Bar Chart",
    width="100%"
  )
krw
# saveWidget(krw, "vispivot.html", selfcontained = FALSE)
```

```{r visbiomvsp, fig.cap = 'Visbiomassa versus fosforbelasting', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

selKol <- c("Numeriekewaarde","Biotaxon.naam.nl","HoortBijGeoobject.identificatie","Begindatum","Resultaatdatum","HoortBijGeoObjectCode","Eenheid.code","GeoObject.code")
sel <- !grepl('^NL11*', EKRlijst$HoortBijGeoobject.identificatie)
sel <- sel & !is.na(EKRlijst$Biotaxon.naam.nl) & !EKRlijst$Biotaxon.naam.nl == "" &!(EKRlijst$Biotaxon.naam.nl %in% "Vissen")  #als geen nederlandse naam dan gaat aggregate fout. En ook niet relevant.
sel <- sel & EKRlijst$Eenheid.code %in% "kg/ha"
EKRlijst1 <- EKRlijst[sel,]

xagg <- aggregate(Numeriekewaarde ~ Biotaxon.naam.nl+jaar+HoortBijGeoobject.identificatie+GeoObject.code,EKRlijst1,FUN=sum)
xagg$jaar <- as.character(xagg$jaar)
xagg <- aggregate(Numeriekewaarde ~ jaar+HoortBijGeoobject.identificatie+GeoObject.code,xagg,FUN=sum)


colgroup <-c('jaar','HoortBijGeoobject.identificatie','Numeriekewaarde','GeoObject.code')
# rename columns and order data.table
setnames(xagg,colgroup,c('jaar','waterlichaam','biomassa','ident'))

#merge vis en pbel
visbelas <- merge(xagg, pvskp, by.x = 'ident', by.y = 'KRW')

p<- ggplot(visbelas, aes(x= wp_min_sum, y= biomassa, col = watertype, label = paste0(waterlichaam, jaar.x)))+
    geom_jitter() +
    #facet_grid(~jaar, scales = 'free')+
    theme_minimal()+
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size = 6), #EAG
      strip.text.y = element_text(size = 5), #EKR
      axis.text.x = element_text(size= 5, angle=90,hjust=1),
      axis.text.y = element_text(size= 5, hjust=2),
      axis.ticks =  element_line(colour = "black"),
      panel.background = element_blank(),
      plot.background = element_blank()
    )+
    ggtitle("Totale visbiomassa tov fosforbelasting") +
    labs(x= 'P-bel', y= 'biomassa')
# krw <-
  ggplotly(p=p)
# saveWidget(krw, "visversuskP.html", selfcontained = FALSE)
```

```{r brasembiomvsp, fig.cap = 'Visbiomassa versus fosforbelasting', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

selKol <- c("Numeriekewaarde","Biotaxon.naam.nl","HoortBijGeoobject.identificatie","Begindatum","Resultaatdatum","HoortBijGeoObjectCode","Eenheid.code","GeoObject.code")
sel <- !grepl('^NL11*', EKRlijst$HoortBijGeoobject.identificatie)
sel <- sel & !is.na(EKRlijst$Biotaxon.naam.nl) & EKRlijst$Biotaxon.naam.nl %in% c('Brasem','Karper') &!(EKRlijst$Biotaxon.naam.nl %in% "Vissen")  #als geen nederlandse naam dan gaat aggregate fout. En ook niet relevant.
sel <- sel & EKRlijst$Eenheid.code %in% "kg/ha"
EKRlijst1 <- EKRlijst[sel,]

xagg <- aggregate(Numeriekewaarde ~ Biotaxon.naam.nl+jaar+HoortBijGeoobject.identificatie+GeoObject.code,EKRlijst1,FUN=sum)
xagg$jaar <- as.character(xagg$jaar)
xagg <- aggregate(Numeriekewaarde ~ jaar+HoortBijGeoobject.identificatie+GeoObject.code,xagg,FUN=sum)


colgroup <-c('jaar','HoortBijGeoobject.identificatie','Numeriekewaarde','GeoObject.code')
# rename columns and order data.table
setnames(xagg,colgroup,c('jaar','waterlichaam','biomassa','ident'))

#merge vis en pbel

visbelasbrkp <- merge(xagg, pvskp, by.x = 'ident', by.y = 'KRW')

p<- ggplot(visbelasbrkp, aes(x= wp_min_sum, y= biomassa, col = watertype, label = paste0(waterlichaam, jaar.x)))+
    geom_jitter() +
    #facet_grid(~jaar, scales = 'free')+
    theme_minimal()+
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size = 6), #EAG
      strip.text.y = element_text(size = 5), #EKR
      axis.text.x = element_text(size= 5, angle=90,hjust=1),
      axis.text.y = element_text(size= 5, hjust=2),
      axis.ticks =  element_line(colour = "black"),
      panel.background = element_blank(),
      plot.background = element_blank()
    )+
    ggtitle("Biomassa braem en karper tov fosforbelasting") +
    labs(x= 'P-bel', y= 'biomassa')
# krw <-
  ggplotly(p=p)
# saveWidget(krw, "brasemkarperversuskP.html", selfcontained = FALSE)
```

#### Trend Vis

In afbeelding \@ref(fig:kaartvisjaren) is te zien hoe vis scoort in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 jaar vegetatie gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartvisjaren, fig.cap = 'Overzicht van gemiddelde EKR scores per EAG van de laatste 3 meetjaren op de maatlat vis', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw <-
combineWidgets(
    ncol = 4, colsize = c(1,1),
    ekrmapKRW(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2010' & EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",],
                 maatlat = "4VI1 Vis-kwaliteit" ),
    ekrmapKRW(EKRset[EKRset$jaar >= '2010' & EKRset$jaar < '2013'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",],
                 maatlat = "4VI1 Vis-kwaliteit" ),
    ekrmapKRW(EKRset[EKRset$jaar >= '2013' & EKRset$jaar < '2016'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",], 
                 maatlat = "4VI1 Vis-kwaliteit" ),
    ekrmapKRW(EKRset[EKRset$jaar >= '2016' & EKRset$jaar < '2020'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",], 
                 maatlat = "4VI1 Vis-kwaliteit" ))
# saveWidget(krw, "vismpjaren.html", selfcontained = FALSE)
# webshot("vismpjaren.html", file = "vis.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen vis achteruit gaat. In `r round((length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit' & ekrtrend$estimate < 0 & !is.na(ekrtrend$estimate)])/length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit' & ekrtrend$estimate > 0 & !is.na(ekrtrend$estimate)])/length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit' & (ekrtrend$estimate == 0| is.na(ekrtrend$estimate))])/length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendvis1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat vis per ecologisch analysegebied tussen 2006 en 2019', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw<-
combineWidgets(
    ncol = 2,
    plottrendKRW(trendekr[trendekr$GHPR_level %in% c('4VI2 Massafractie Visgilde - plantminnende soort (Pm)','4VI2 Soortenrijkdom Visgilde - plantminnende en migrerende soort (PmM)'),], gKRW),
    plottrendKRW(trendekr[trendekr$GHPR_level == '4VI2 Massafractie Visgilde - zuurstoftolerante soort (O2)',], gKRW)
)

combineWidgets(
    ncol = 2,
    plottrendKRW(trendekr[trendekr$GHPR_level == '4VI2 Massafractie Visgroep - brasem en karper (BK)',], gKRW),
    plottrendKRW(trendekr[trendekr$GHPR_level == '4VI2 Massafractie Visgroep - baars en blankvoorn (BB)',], gKRW)
)
#saveWidget(krw, "visdeelmtlt.html", selfcontained = FALSE)
```

## Aanwezigheid Natura2000 indicatorsoorten

In de kaarten hieronder is de som van bedekkingen van verschillende taxa kranswieren en fonteinkruiden per meetlocatie weergegeven. De totale bedekking met Krabbenscheer en Groot blaasjeskruid staan ook op onderstaande kaarten weergegeven. 

### Kranswieren
Hieronder staan gesommeerde bedekingspercentages per meetlocatie per jaar van de gevonden taxa van Characea, Nitella en Nitellopsis.

```{r kaartkranswierenmj, fig.cap = 'Overzicht van de waargenomen kranswieren 2006 t/m 2012 links en 2013 t/m 2018 rechts', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw<-
combineWidgets(
    ncol = 2, colsize = c(1, 1),
    kaartmcftchara(hybi[hybi$jaar > 2005 & hybi$jaar < 2013,]),
    kaartmcftchara(hybi[hybi$jaar > 2012 & hybi$jaar < 2019,])
)
#saveWidget(krw, "kranswieren.html", selfcontained = FALSE)
#webshot("kranswieren.html", file = "kranswieren.png")
```

```{r kaartkranswieren, fig.cap = 'Overzicht van de waargenomen kranswieren 2015 t/m 2017', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw<-
kaartmcftchara(hybi[hybi$jaar > 2014 & hybi$jaar < 2019,])
#saveWidget(krw, "kranswieren2.html", selfcontained = FALSE)
#webshot("kranswieren2.html", file = "kranswieren2.png")
```

### Fonteinkruiden
Hieronder staan gesommeerde bedekkingspercentages van alle taxa fonteinkruiden (behalve Potamogeton pectinatus).

```{r kaartfonteinmj, fig.cap = 'Overzicht van de waargenomen fonteinkruiden 2006 t/m 2012 links en 2012 t/m 2018 rechts', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw<-
combineWidgets(
    ncol = 2, colsize = c(1, 1),
    kaartfontein(hybi[hybi$jaar > 2005 & hybi$jaar < 2013,]),
    kaartfontein(hybi[hybi$jaar > 2012 & hybi$jaar < 2019,])
)
#saveWidget(krw, "fonteinkruiden.html", selfcontained = FALSE)
#webshot("fonteinkruiden.html", file = "fonteinkruiden.png")
```


```{r fkaart2017, fig.cap = 'Overzicht van de waargenomen fonteinkruiden 2015 t/m 2018', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw<-
kaartfontein(hybi[hybi$jaar > 2014 & hybi$jaar < 2019,])
#saveWidget(krw, "fonteinkruiden2.html", selfcontained = FALSE)
#webshot("fonteinkruiden2.html", file = "fonteinkruiden2.png")
```

### Krabbenscheer

```{r kaartkr, fig.cap = 'Overzicht van de waargenomen Krabbenscheer 2006 t/m 2012 links en 2013 t/m 2018 rechts', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
combineWidgets(
    ncol = 2, colsize = c(1, 1),
    kaartstrat(hybi[hybi$jaar > 2005 & hybi$jaar < 2013,]),
    kaartstrat(hybi[hybi$jaar > 2012 & hybi$jaar < 2019,])
)
```

```{r kaartstratmj, fig.cap = 'Overzicht van de waargenomen Krabbenscheer 2014 t/m 2018', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw<-
kaartstrat(hybi[hybi$jaar > '2013',])
#saveWidget(krw, "strat.html", selfcontained = FALSE)
#webshot("strat.html", file = "strat.png")
```

### Groot blaasjeskruid

```{r kaartutrmj, fig.cap = 'Overzicht van de waargenomen Groot blaasjeskruid 2006 t/m 2017', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
kaartutr(hybi[hybi$jaar > '2006',])
```

### Overzicht exoten
### Kreeft
Inheemse rivierkreeft ondervindt het laatste decennium hevige concurrentie van meerdere invasieve exoten (zoals de rode Amerikaanse rivierkreeft) die in hoog tempo de Nederlandse wateren domineren. In grote aantallen grazen deze exoten op oever- en submerse vegetatie. Het vermoeden is dat een deel van de planten daadwerkelijk gegeten wordt, maar er wordt vooral gejaagd op de macrofauna die zich op en tussen de vegetatie bevindt. Tijdens hun jacht op macrofauna woelen rivierkreeften de bodem. Daarnaast graven ze holen in de oevers wat ook leidt tot omwoeling. Hoge dichtheden aan kreeften kan dus leiden tot verhoogde concentraties aan zwevend stof in het oppervlaktewater. Daarmee hebben kreeften een vergelijkbare rol als bodemwoelende vissen (brasem en karper).

De hoeveelheid rivierkreeften in het beheergebied van AGV is niet consequent bemonsterd in de afgelopen jaren, maar sinds 2015 worden kreeften die als bijvangst worden gevangen tijdens de bemonstering van vis wel gerapporteerd. Sinds 2006 wordt de aanwezigheid van rivierkreeften geregistreerd bij de bemonstering van waterbeestjes. In onderstaand plaatje worden deze vangsten getoond. Dit plaatje zegt dus alleen wat over de locaties waar we zeker zijn dat er wél kreeft voorkomt. 

In de basis worden er in watersystemen 3 toestanden onderscheiden, namelijk een stabiel helder systeem, een stabiel troebel systeem en een toestand daartussen. Wanneer een watersysteem zich in een 'tussentoestand' bevindt kan er door ingrijpen in het voedselweb een omslag naar een stabiel helder systeem geforceerd worden. Het effect hiervan is bekend bij bodemwoelende vis. Wanneer dit ook bij kreeften het geval blijkt te zijn, dan kan het verminderen van de aanwezigheid van kreeften ook een dergelijke omslag veroorzaken. Deze methode is echter nog onbeproefd en er is een goed beeld nodig van de aanwezige kreeften voor het effect van actief biologisch beheer kan worden ingeschat. De bemonsteringen en afvangexperimenten die momenteel worden uitgevoerd in de Molenpolder zullen in de aankomende jaren een beter beeld geven van de kreeftenpopulatie in de Molenpolder, waarmee deze vraag beter kan worden beantwoord.

```{r kaartkreeft, fig.cap = 'Overzicht van gevonden kreeften. In gebieden waar geen kreeft is gevonden is dezevaak ook niet gemonitord. Onderstaande kaart zegt dus alleen iets over de aanwezigheid van kreeft.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
kaartkreeft(hybi)
```

### Andere exoten

```{r kaartcam, fig.cap = 'Overzicht van Cabomba', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
kaartcam(hybi)

```

```{r kaartved, fig.cap = 'Overzicht van ongelijkbladig vederkruid', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
kaartved(hybi)
```


# Gebruikte methoden
## KRW toetsing
Alle beschikbare meetgegevens van hydrobiologische kwaliteitselementen zijn getoetst aan landelijke
beoordelingsmethodiek voor sloten, kanalen (Omschrijving MEP en maatlatten voor sloten en kanalen, STOWA rapport 2012-34) en meren (Referenties en maatlatten voor natuurlijke watertypen voor de Kaderrichtlijn Water, STOWA rapport 2012-31). Het resultaat hiervan is een duiding van ecologische kwaliteit (EKR score). 

Een score van 1 staat voor een maximaal haalbare ecologische kwaliteit in water dat niet door menselijk toedoen wordt verstoord. Een score van 0.6 staat voor een haalbare ecologische kwaliteit in water dat door de mens is gemaakt bij het winnen van turf en zand. Of water dat wordt gebruikt om in te varen of als afvoer om het land en de straat droog te houden. In onderstaande afbeeldingen staat een goede kwaliteit verbeeld. 

Er kan slechts aan één watertype getoetst worden, omdat één waterlichaam volgens de Europese richtlijn, slechts uit één watertype kan bestaan. Er wordt getoetst aan de watertypen zoals vastgesteld in het WBP 2016-2021. Er zijn toestgegevens beschikbaar van gehele KRW waterlichamen en EAG`s. Het watertype waaraan getoetst wordt als pop-up weergegeven in de kaarten in paragrafen [KRW waterlichamen] en [Ecologische analysegebieden].

### KRW waterlichamen

Voor de KRW is een groot deel van het oppervlaktewater aangewezen als waterlichaam. Een waterlichaam is een "onderscheiden oppervlaktewater van aanzienlijke omvang, zoals een meer, een rivier of een kanaal". Voor deze wateren moet de toestand van het aquatisch ecosysteem beschreven worden. Onder oppervlaktewater van "aanzienlijke omvang" vallen waterlichamen met een minimale oppervlakte van 0,5 km2 of een stroomgebied tussen de 10 en 100 km2. In onderstaande afbeelding staan de KRW waterlichamen in het beheergebied van AGV.

In de Kaderrichtlijn Water (KRW) is een indeling gemaakt in verschillende typen oppervlaktewater. Deze zijn ingedeeld naar hydromorfologische eigenschappen, type bodem en naar zoet, brak of zout water. De hydromorfologische eigenschappen zijn de stroming, de grootte of breedte en de diepte. Een belangrijk onderscheid is in stilstaand of stromend water. De bodem is belangrijk voor het onderscheid naar een veenbodem (met veel organisch materiaal), kiezels, klei, zand of kalk. Deze indeling is belangrijk voor de doelen die in de KRW gesteld worden, omdat voor elk watertype kwaliteitseisen opgesteld zijn. De watertypen worden zichtbaar wanneer er op een waterlichaam wordt geklikt.

```{r wl, fig.cap = 'Overzicht van KRW waterlichamen in het beheergebied van AGV', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
## Dissolve polygons with same area IDs ---------
gKRW <- gKRW %>% group_by(OWMIDENT,OWMNAAM) %>% summarize()
eag_wl1 <- eag_wl %>% group_by(KRW_SGBP3,watertype) %>% summarize()
gKRW <- merge(gKRW,eag_wl1[,c('KRW_SGBP3','watertype')], by.x = "OWMIDENT", by.y = "KRW_SGBP3", all.x = TRUE, all.y = F)%>% st_transform(proj4.google)
# krw <-
krwmap(gKRW)
# saveWidget(krw, "waterlichamen.html", selfcontained = FALSE)
#webshot("waterlichamen.html", file = "waterlichamen.png")
```

### Ecologische analysegebieden

De Ecologische analysegebieden zijn een gebiedsindeling om het ecologisch functioneren van het watersysteem te beoordelen en het effect van maatregelen op de waterkwaliteit te volgen, waarbij gebruik wordt gemaakt van analysemodellen zoals de water- en stoffenbalans, opdat het waterbeheer doelmatig en efficiënt kan plaatsvinden en KRW-doelstellingen worden behaald.

Ecologische analysegebieden (EAG’s) zijn nieuwe opdelingen van de bestaande af- en aanvoergebieden, meestal (delen van) polders. De opdeling in EAG’s is gemaakt op basis van een aantal kenmerken zoals vorm, verblijftijd, waterdiepte, strijklengte, de aanwezigheid van kwel of wegzijging en de afvoerrichting van het water. Een EAG valt altijd volledig binnen een afvoergebied. Af-en aanvoergebieden, maar ook KRW-waterlichamen, zijn dus opgebouwd uit één of meer EAG’s.

Ook EAG`s in het 'overig water' die niet zijn aangewezen als KRW waterlichaam hebben een KRW watertype toegekend gekregen.

```{r eag1, fig.cap = 'Overzicht van KRW waterlichamen in het beheergebied van AGV', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
eagoverzicht(gEAG, eag_wl)
```

### Selectie monsters

Alleen meetjaren waarin een geheel waterlichaam of EAG is bemonsterd zijn meegenomen in de toetsing om een representatief beeld te krijgen van de ecologische toestand. In de waterlichamen Tussenboezem Vinkeveen B en Molenpolder en Tienhoven zijn in verschillende deelgebieden niet bemonsterd in het verleden, om toch een beeld te krijgen van de ontwikkeling in ecologische toestand in deze gebieden is de beperkte dataset van deze deelgebieden wél meegenomen. Dit kan een vertekend beeld geven, omdat de deelgebieden die meewegen in de eindscore van het gehele waterlichaam variëren per meetjaar.

Macrofauna dat is bemonsterd onder de spronglaag in diepe plassen wordt niet meegenomen in de toetsing.

### Weging meetlocaties en trajecten

Bij biologische kwaliteitselementen is er een weging aan meetpunten toegekend. Er is rekening gehouden met het relatieve aandeel dat een deelgebied heeft in een geheel KRW waterlichaam en de bemonsteringsinspanning binnen een deelgebied. De wijze waarop de weegfactoren zijn uitgerekend, verschilt per watertype en kwaliteitselement.
	
Voor macrofauna, fytoplankton en macrofyten is de volgende formule toegepast:

$$
\begin{aligned}
Gewicht per meetlocatie = 
\frac{wateroppervlakte van het deelgebied waar de locatie in valt}{wateroppervlakte van het waterlichaam waar de locatie in valt \times totaal aantal meetlocaties in een deelgebied}
\end{aligned}
$$

Als deelgebieden worden de Ecologische Analyse Gebieden (EAG) gebruikt. Bij macrofyten wordt onderscheid gemaakt tussen monsters in de emerse zone (ez) en monsters in de open water zone (ow). Een macrofytenmonster op één meetlocatie in meren en plassen bevat niet de gehele vegetatiegradiënt, maar één vegetatiezone (een diepere submerse zone, de ondiepe emerse zone of een oeverzone). Voor de toetsing zijn monsters uit verschillende vegetatiezones samengevoegd tot één meetlocatie, zodat iedere locatie alle vegetatiezones (oever, emers en submers) bevat. Dit betekent dat dezelfde monsters soms meerdere malen aan een meetlocatie zijn toegekend en dat de monsters in de emerse zone evenzwaar meetellen als de monsters in de submerse zone. In meren met watertype M20, M27, M14 zijn de taxa van submerse vegetatie verwijderd uit het monster uit de emerse zone, omdat een enkele meting van een minder soortenrijke onderwatervegetatie in de emerse zone onevenredig zwaar meeweegt in de toetsing.

Bij vis is de volgende formule toegepast:

$$
\begin{aligned}
Gewicht per traject = 
(\frac{wateroppervlak van het deelgebied waar het traject in valt}{wateroppervlak van het beviste waterlichaam waar het traject in valt}) \times
(\frac{bevist oppervlak van traject}{totaal bevist oppervlak van alle trajecten in het deelgebied})
\end{aligned}
$$

In lijnvormige wateren (M1, M8, M10) wordt gevist met een elektrisch schepnet of met een elektrisch schepnet in combinatie met een zegen en keernetten. In het laatste geval vallen er twee monsters onder één traject en wordt deze samengevoegd. Het bevist oppervlak is dan per traject gesommeerd. In meervormige wateren en de boezem (M14, M27, M20, M7, M6) worden naast EAG's ook aparte deelgebieden onderscheidden per dieptezone (0-1 meter, 1-8 meter, >8 meter). Het oppervlak van de emerse zone (0-1 meter) is over het algemeen klein in vergelijking tot het totaal oppervlak van waterlichamen van deze watertypen. Daarom weegt de emerse zone, waar de meeste vis zit, minder zwaar mee dan de overige dieptezones. Soms zitten er lijnvormige wateren vast aan een plas. Deze worden bevist met electrisch schepnet (en zegen) met keernetten. Deze worden als apart deelgebied ook meegewogen.

### Conversie & aanvulling data

Fytoplankton is bij monsters die voor 2014 zijn genomen, alleen als waarnemingen per milliliter gerapporteerd. Voor de toetsing is de eenheid cellen/ml nodig. Meetwaarden van 2014 en eerder zijn vertaald naar cellen/ml met behulp van de vertaaltabel in (Referenties en maatlatten voor natuurlijke watertypen voor de Kaderrichtlijn Water, STOWA rapport 2012-31).

De vestigingsdiepte van vegetatie is pas vanaf 2013 bepaald. Vestigingsdiepte in eerdere meetjaren is berekend op basis van de gemeten verticale extinctie. De vestigingsdiepte is afgeleid uit verticale extinctie obv de berekende lineaire relatie tussen vestigingsdiepte en verticale extinctie in diepe plassen in 2014 t/m 2017. Er zijn twee correcties op deze berekening toegepast:
    1. Wanneer de gemeten submerse bedekking 0 is, is de vestigingsdiepte ook op 0 gezet. 
    2. Wanneer de berekende vestigingsdiepte kleiner is dan de maximale diepte waarop submerse bedekking is gevonden, dan is de diepte waarop submerse bedekking is gevonden voor de toetsing gebruikt.
    
Groeivormen worden aangevuld wanneer ze ontbreken in de data:
* Het sluitingspercentage en breedte van de oeverzone wordt alleen in het Naardermeer bepaald. Deze staat standaard op 0. 
* Grote drijfbladplanten in meren en plassen wordt berekend door de som van drijvende taxa wanneer deze ontbreekt. 
* Emerse planten, FLAB en KROOS staan op 0 waar ze missen, omdat deze niet uit de data kunnen worden afgeleid. 

De abundantie van vegetatie wordt vertaald naar een driedelige-KRW-opnameschaal. Gehanteerde grenswaarde tussen 'weinig', 'matig' en 'veel' bij verschillende vegetatieopnameschalen zijn:

*	Tansley schaal: 4, 8
*	Nat schaal: 2, 6
*	Bedekkingspercentages: 5, 50

## Trendanalyse
Per maatlat en ecologisch analysegebied is een lineaire trend in EKR-scores van de afgelopen 12 jaar bepaald. In de figuren met trends in EKR scores worden alleen trends getoond van gebieden waar voor minimaal 2 meetjaren gegevens beschikbaar zijn en waarvan de relevantie voldoende is (meer dan 0.05 ekr per 12 jaar).

## Natura2000
In de kaarten is de som van bedekkingen van verschillende taxa kranswieren en fonteinkruiden per meetlocatie weergegeven. Niet in ieder meetjaar is met dezelfde opnamemethode gewerkt. De som van bedekkingen wordt dus in verschillende eenheden uitgedrukt. In het verleden werd met een Tansley bedekkingschaal gewerkt in lijnvormige wateren en met een 'Emile Nat abundantieschaal' in plassen. Hierin worden de volgende abundantieklassen onderscheiden: 

1: aangetroffen met weinig materiaal in één van de windrichtingen
2: idem in twee van de windrichtingen
3: idem in drie van de windrichtingen
4: idem in vier van de windrichtingen
5: aangetroffen met veel materiaal in één van de windrichtingen
6: idem in twee van de windrichtingen
7: idem in drie van de windrichtingen
8: idem in vier van de windrichtingen

Vanaf 2014 zijn alle taxa in een opname uitgedrukt als percentage bedekking van het proefvlak waarin een opname plaatsvond.

### Trendanalyse
Per maatlat en ecologisch analysegebied is een lineaire trend in EKR-scores van de afgelopen 12 jaar bepaald. In de figuren met trends in EKR scores worden alleen trends getoond van gebieden waar voor minimaal 3 meetjaren gegevens beschikbaar zijn en waarvan de P waarde < 0.35. 
Gebieden waar een significante trend is berekend (P waarde < 0.05) zijn rood gemarkeerd.

Scores in de Gaasperplas en Amsterdam zijn ('2220-EAG-1', '1000-EAG-1', '2000-EAG-1') niet meegenomen, omdat de toetsresultaten hier geen representatief beeld geven van het gehele systeem en de bemonsterde locaties teveel verschillen tussen meetjaren.






